---
description: 現在のブランチのプルリクエストコメントを確認し、分類して修正を実施
allowed-tools: Read, Write, SearchReplace, Bash, TodoWrite, CodebaseSearch, Grep
argument-hint: [PR番号] [--auto-apply-critical]
---

# プルリクエストレビューコメント修正コマンド

<background_information>
- **Mission**: 指定されたプルリクエスト（または現在のブランチに関連するプルリクエスト）のコメントを取得し、重要度別に分類して要約を表示。ユーザー確認後に修正を実施
- **Success Criteria**:
  - プルリクエストのコメントを正確に取得
  - コメントを3つのカテゴリ（必須、推奨、改善）に適切に分類
  - 修正内容を明確に要約して表示
  - ユーザー確認後に適切な修正を実施
</background_information>

<instructions>
## Core Task
指定されたPR番号（または現在のブランチ）のプルリクエストコメントを取得し、分類して要約表示。ユーザー確認後に修正を実施。

## Parse Arguments
- `<PR番号>`: 数値が指定された場合、そのPR番号のプルリクエストを対象とする（例: `25`）。指定がない場合は現在のブランチから自動検索
- `--auto-apply-critical`: 必須修正のみ自動適用（確認をスキップ）

## Validation
実行前に以下を確認:
1. Gitリポジトリが初期化されている
2. 現在のブランチが存在する
3. GitHub CLI (`gh`)がインストールされている
4. GitHub CLIが認証されている
5. リモートリポジトリが設定されている

検証に失敗した場合、具体的なエラーを報告し、解決方法を提案。

## Execution Steps

### Step 1: PR番号の判定とブランチ準備

引数 `$ARGUMENTS` を解析し、PR番号が指定されているか判定する:

1. **PR番号が指定されている場合**（引数に数値が含まれる場合）:
   - 指定されたPR番号の情報を取得:
     ```bash
     gh pr view <PR番号> --json number,title,url,state,headRefName
     ```
   - PRが存在しない場合、エラーを報告して終了
   - PRの `headRefName`（ブランチ名）を取得
   - 現在のブランチを確認し、異なる場合はPRのブランチにチェックアウト:
     ```bash
     git fetch origin <headRefName>
     git checkout <headRefName>
     ```
   - チェックアウト後、リモートの最新状態を反映:
     ```bash
     git pull origin <headRefName>
     ```

2. **PR番号が指定されていない場合**:
   - 現在のブランチ名を取得:
     ```bash
     git rev-parse --abbrev-ref HEAD
     ```

3. リモートリポジトリ情報を取得:
   ```bash
   git remote get-url origin
   ```
   - GitHub形式: `git@github.com:owner/repo.git` または `https://github.com/owner/repo.git`
   - リポジトリオーナーと名前を抽出（例: `Shirataki2/discalendar-next-v2`）

### Step 2: GitHub CLIでプルリクエストを検索

**PR番号が指定されている場合**: Step 1 で既に取得済みのため、このステップをスキップ。

**PR番号が指定されていない場合**: 現在のブランチに関連するプルリクエストを検索:

```bash
gh pr list --head <current-branch> --json number,title,url,state,headRefName
```

**注意**:
- 複数のPRが見つかった場合は、最新のオープンなPRを選択
- PRが見つからない場合、エラーを報告

### Step 3: プルリクエストのコメントを取得

見つかったプルリクエストの以下のコメントを取得:

1. **プルリクエスト本体のコメント**:
   ```bash
   gh pr view <pr-number> --json comments --jq '.comments[] | {id: .id, body: .body, author: .author.login, createdAt: .createdAt}'
   ```

2. **レビューコメント（ファイルへのコメント）**:
   ```bash
   gh pr view <pr-number> --json reviewThreads --jq '.reviewThreads[] | {path: .path, line: .line, comments: .comments[] | {body: .body, author: .author.login, createdAt: .createdAt}}'
   ```

3. **レビューコメント（レビュー全体）**:
   ```bash
   gh pr view <pr-number> --json reviews --jq '.reviews[] | {state: .state, body: .body, author: .author.login, createdAt: .createdAt}'
   ```

**取得したデータを構造化**:
- 各コメントにファイルパス、行番号、コメント本文、作成者、作成日時を記録
- コメント本文を解析して、重要度の判定に使用

### Step 4: コメントの分類

取得したコメントを以下の3つのカテゴリに分類。各コメントの本文、コンテキスト、キーワードを分析:

#### 🔴 必ず修正すべきもの (Critical)
以下のいずれかに該当するコメント:
- バグやセキュリティ問題を指摘
- テスト失敗やビルドエラーを報告
- 機能の不具合を指摘
- 明確な「必須」「必須修正」「バグ」「エラー」「修正が必要」などのキーワードを含む
- レビューステータスが `CHANGES_REQUESTED` または `COMMENT` で、深刻な問題を指摘
- セキュリティ関連のキーワード（`security`, `vulnerability`, `leak`, `expose`など）

#### 🟡 修正した方が良いもの (Recommended)
以下のいずれかに該当するコメント:
- コード品質の改善提案
- パフォーマンス最適化の提案
- ベストプラクティスに沿った改善提案
- 「推奨」「改善」「検討」「提案」「最適化」などのキーワードを含む
- リファクタリングの提案
- アーキテクチャの改善提案

#### 🟢 コードの可視性を向上させる修正 (Enhancement)
以下のいずれかに該当するコメント:
- コメントの追加・改善の提案
- 変数名の改善提案
- 型定義の明確化の提案
- ドキュメントの追加提案
- 「可読性」「ドキュメント」「コメント」「命名」「型」などのキーワードを含む
- コードの説明を追加する提案

**分類ロジック**:
1. コメント本文を小文字に変換してキーワード検索
2. ファイルパスと行番号のコンテキストを考慮
3. レビューステータスを考慮（`CHANGES_REQUESTED`は優先度高め）
4. 複数のカテゴリに該当する場合は、より重要度の高いカテゴリに分類

### Step 5: 要約の表示

分類結果を以下の形式で表示（日本語で）:

```markdown
# プルリクエストレビューコメント要約

## 📊 概要
- **プルリクエスト**: #<number> - <title>
- **URL**: <pr-url>
- **総コメント数**: <total>
- **必須修正**: 🔴 <critical-count>件
- **推奨修正**: 🟡 <recommended-count>件
- **改善提案**: 🟢 <enhancement-count>件

## 🔴 必ず修正すべきもの (<critical-count>件)

### 1. [コメントの要約タイトル]
- **ファイル**: `path/to/file.ts`
- **行番号**: 123
- **作成者**: @username
- **コメント**: 
  ```
  <コメント内容>
  ```
- **修正方針**: <修正の方向性と具体的なアクション>

### 2. ...

## 🟡 修正した方が良いもの (<recommended-count>件)

### 1. [コメントの要約タイトル]
- **ファイル**: `path/to/file.ts`
- **行番号**: 456
- **作成者**: @username
- **コメント**: 
  ```
  <コメント内容>
  ```
- **修正方針**: <修正の方向性と具体的なアクション>

### 2. ...

## 🟢 コードの可視性を向上させる修正 (<enhancement-count>件)

### 1. [コメントの要約タイトル]
- **ファイル**: `path/to/file.ts`
- **行番号**: 789
- **作成者**: @username
- **コメント**: 
  ```
  <コメント内容>
  ```
- **修正方針**: <修正の方向性と具体的なアクション>

### 2. ...
```

### Step 6: ユーザー確認

要約を表示した後、以下の確認を取る（`--auto-apply-critical`が指定されていない場合）:

```
上記の修正を実施しますか？

選択肢:
1. すべての修正を実施
2. 必須修正のみ実施
3. 必須修正 + 推奨修正を実施
4. カスタム選択（個別に指定）
5. キャンセル

実行する場合は「1」「すべて」「必須のみ」などと入力してください。
```

**引数 `--auto-apply-critical` が指定されている場合**:
- 必須修正のみ自動的に適用（確認をスキップ）
- 推奨修正と改善提案はスキップ

### Step 7: 修正の実施

ユーザーの選択に基づいて修正を実施:

1. **TodoWriteでタスク管理**:
   - 各修正項目をタスクとして登録
   - タスクID: `pr-fix-{category}-{index}`
   - タスク内容: ファイルパスと修正内容の要約
   - 修正が完了したらタスクを完了としてマーク

2. **修正の実行**:
   - 各コメントに対応するファイルを読み込む（Read tool）
   - コメントの内容を分析し、適切な修正を実施
   - 修正には以下を使用:
     - `SearchReplace`: 既存コードの置換
     - `Write`: 新規ファイルの作成や大幅な変更
   - 修正後、該当ファイルを保存

3. **修正内容の記録**:
   - 各修正について、変更内容を簡潔に記録
   - 修正前後の差分を要約
   - 修正が完了したら、修正サマリーを表示

**修正の優先順位**:
1. 必須修正（Critical）を最優先
2. 推奨修正（Recommended）を次に実施
3. 改善提案（Enhancement）を最後に実施

### Step 8: 修正完了後の確認

修正完了後、以下の情報を表示（日本語で）:

```markdown
# 修正完了サマリー

## ✅ 実施した修正
- **必須修正**: 🔴 <count>件
- **推奨修正**: 🟡 <count>件
- **改善提案**: 🟢 <count>件

## 📝 修正内容の詳細

### 必須修正
1. **ファイル**: `path/to/file.ts`
   - **変更内容**: <変更の要約>
   - **行番号**: 123-125

2. ...

### 推奨修正
1. **ファイル**: `path/to/file.ts`
   - **変更内容**: <変更の要約>
   - **行番号**: 456-458

2. ...

### 改善提案
1. **ファイル**: `path/to/file.ts`
   - **変更内容**: <変更の要約>
   - **行番号**: 789-791

2. ...

## 🔍 次のステップ
1. 修正内容を確認してください（`git diff`で変更を確認）
2. 必要に応じてテストを実行してください
3. プルリクエストにコメントを追加して修正完了を報告してください
4. 修正が完了したコメントに「修正しました」などの返信を追加することを検討してください
```

## Error Handling

- **GitHub CLIがインストールされていない場合**:
  - エラーを報告
  - GitHub CLIのインストール方法を提案: `brew install gh` (macOS) または公式サイトを参照

- **GitHub CLIが認証されていない場合**:
  - エラーを報告
  - 認証方法を提案: `gh auth login`

- **指定されたPR番号が存在しない場合**:
  - PR番号が正しいか確認を促す
  - `gh pr list` でオープンなPR一覧を表示して選択を促す

- **PR番号指定時にチェックアウトに失敗した場合**:
  - ローカルに未コミットの変更がないか確認を促す（`git stash` を提案）
  - ブランチがローカルに存在しない場合は `git fetch` を実行
  - 具体的なエラーメッセージを表示

- **プルリクエストが見つからない場合**（PR番号未指定時）:
  - 現在のブランチがリモートにプッシュされているか確認を促す
  - ブランチ名が正しいか確認を促す
  - 手動でPRを作成することを提案

- **コメントが取得できない場合**:
  - プルリクエストの状態を確認（オープン/クローズ）
  - アクセス権限を確認
  - リポジトリへのアクセス権限があるか確認

- **ファイルが見つからない場合**:
  - コメントで指定されたファイルパスが存在するか確認
  - ファイルが移動または削除された可能性を報告
  - 代替ファイルを提案

- **修正に失敗した場合**:
  - 具体的なエラーメッセージを表示
  - 修正が必要な箇所を明確に示す
  - 手動での修正を提案

## Output Description

出力は日本語で以下の構造で提供:

1. **実行モード**: 自動モードまたは対話モード
2. **取得した情報**:
   - プルリクエスト情報（番号、タイトル、URL）
   - コメントの総数と分類
3. **分類結果**: カテゴリ別のコメント一覧
4. **修正実施**: 実施した修正の詳細
5. **修正完了サマリー**: 修正内容の要約
6. **次のステップ**: フォローアップアクション

**Format Requirements**:
- Markdown見出しを使用（##, ###）
- コマンドはコードブロックで囲む
- 出力は簡潔で明確に
- ユーザー向けメッセージはすべて日本語
- エラーメッセージは具体的で解決策を含む
</instructions>

## Tool Guidance
- **Bash**: GitHub CLIコマンドの実行
- **Read**: ファイルの読み込みとコメントの分析
- **Write/SearchReplace**: 修正の実施
- **TodoWrite**: タスク管理
- **CodebaseSearch/Grep**: 関連コードの検索

## Safety & Fallback
- **PRが見つからない**: エラーを報告し、手動での確認を提案
- **コメントが空**: 情報メッセージを表示し、次のステップに進む
- **分類が困難**: デフォルトで「推奨修正」に分類し、ユーザーに確認
- **修正が複雑**: 修正方針を明確に示し、ユーザーに確認を取る
- **部分的な成功**: 成功した修正と失敗した修正を明確に分けて報告
