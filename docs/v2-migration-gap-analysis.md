# DisCalendar V2 → Next.js 移植: 不足機能分析

V2（Nuxt.js/Vue 2）と現行 Next.js 実装を比較し、未移植の機能を整理したドキュメント。

## 参照元

- **V2**: `refs/DisCalendarV2/web`（Nuxt.js + Vue 2 + Vuetify）
- **現行**: `discalendar-next`（Next.js 16 + React 19 + shadcn/ui）

---

## V2 機能一覧と移植状況

### ページ / ルート

| V2 ルート | 機能 | 移植状況 |
|-----------|------|----------|
| `/` | ランディングページ | ✅ 実装済み |
| `/login` | Discord OAuth ログイン | ✅ `/auth/login` として実装済み |
| `/callback` | OAuth コールバック | ✅ `/auth/callback` として実装済み |
| `/logout` | ログアウト（Cookie 全削除） | ⚠️ サーバーアクションで代替（専用ページなし） |
| `/dashboard` | ギルド選択 + カレンダー | ✅ 実装済み |
| `/dashboard/:id` | ギルド別カレンダー | ✅ ギルド切り替えで実現 |
| `/docs/:slug` | ドキュメントページ | ❌ 未実装 |
| `/support/:slug` | 利用規約・プライバシーポリシー | ❌ 未実装 |
| `/authorized` | 認証テスト | ⛔ 移植不要 |

### カレンダー機能

| 機能 | V2 | 現行 | 状況 |
|------|-----|------|------|
| 月表示 | ✅ | ✅ | ✅ 実装済み |
| 週表示 | ✅ | ✅ | ✅ 実装済み |
| 日表示 | ✅ | ✅ | ✅ 実装済み |
| 4日表示 | ✅ | ❌ | ❌ 未実装 |
| イベント作成 | ✅ | ✅ | ✅ 実装済み |
| イベント編集 | ✅ | ✅ | ✅ 実装済み |
| イベント削除 | ✅ | ✅ | ✅ 実装済み |
| 終日イベント | ✅ | ✅ | ✅ 実装済み |
| イベント色分け | ✅ | ✅ | ✅ 実装済み |
| ドラッグ移動 | ✅ | ✅ | ✅ 実装済み |
| ドラッグリサイズ（時間延長） | ✅ | ⚠️ | ⚠️ 要確認 |
| イベント通知設定 | ✅（最大10件） | ❌ | ❌ 未実装（DB は準備済み） |
| 日付ピッカーナビゲーション | ✅ | ❌ | ❌ 未実装 |

### 認証・権限

| 機能 | V2 | 現行 | 状況 |
|------|-----|------|------|
| Discord OAuth ログイン | ✅ | ✅ | ✅ 実装済み |
| セッション管理（Cookie） | ✅ | ✅ | ✅ Supabase SSR で実装 |
| トークン自動リフレッシュ | ✅ | ⚠️ | ⚠️ Supabase 側は自動、Discord API トークンは不十分 |
| ギルド内権限チェック | ✅ | ❌ | ❌ 未実装 |
| 管理者のみ編集制限 | ✅ | ❌ | ❌ 未実装 |

### ギルド管理

| 機能 | V2 | 現行 | 状況 |
|------|-----|------|------|
| ギルド一覧表示 | ✅ | ✅ | ✅ 実装済み |
| ギルドアイコン表示 | ✅ | ✅ | ✅ 実装済み |
| ギルド選択・切り替え | ✅ | ✅ | ✅ 実装済み |
| BOT 招待フロー | ✅ | ❌ | ❌ 未実装 |
| ギルド設定（restricted） | ✅ | ❌ | ❌ 未実装 |

### UI / UX

| 機能 | V2 | 現行 | 状況 |
|------|-----|------|------|
| ダーク / ライトテーマ | ✅ | ✅ | ✅ 実装済み |
| レスポンシブデザイン | ✅ | ✅ | ✅ 実装済み |
| ナビゲーションドロワー | ✅ | ⚠️ | ⚠️ ギルドサイドバーのみ（汎用ナビなし） |
| ローディングアニメーション | ✅ | ✅ | ✅ 実装済み |
| フッター（バージョン表示） | ✅ | ✅ | ✅ 実装済み |

---

## 不足機能の詳細

### 1. イベント通知設定 (Notifications)

**V2 の実装:**
- イベントごとに最大 10 件の通知を設定可能
- 通知タイミング: 数値（1〜100） × 単位（週間前 / 日前 / 時間前 / 分前）
- `NotificationBtn.vue` コンポーネントで UI 提供
- `NewEvent.vue` のフォーム内に組み込み

**現行の状況:**
- DB テーブル（`bot_settings` / notifications 関連）は migration で作成済み
- `EventForm` に通知設定 UI が存在しない
- サービス層にも通知 CRUD ロジックがない

**必要な作業:**
- 通知設定 UI コンポーネントの作成
- `EventForm` への組み込み
- `EventService` への通知 CRUD 追加
- 型定義の追加

---

### 2. ギルド権限チェック

**V2 の実装:**
- `getUserPermissions()` で Discord API からギルド内権限を取得
- Bitwise 演算で Admin / Manage Guild / Manage Messages / Manage Roles を判定
- `restricted` フラグが有効な場合、権限のないユーザーはイベント編集不可
- UI でボタン表示 / 非表示を制御

**現行の状況:**
- 全認証ユーザーが全操作可能（権限チェックなし）
- Discord API からの権限取得ロジックがない

**必要な作業:**
- Discord 権限取得 API の実装
- 権限チェックミドルウェア / フック
- UI での権限ベース表示制御
- RLS ポリシーの強化（可能であれば）

---

### 3. BOT 招待フロー

**V2 の実装:**
- ダッシュボードで「BOT が参加しているギルド」と「まだ参加していないギルド」を分けて表示
- 未参加ギルドに「BOT を招待」ボタンを配置
- `INVITATION_URL` 環境変数で招待 URL を管理

**現行の状況:**
- BOT 参加済みギルドのみ表示
- 招待 UI がない

**必要な作業:**
- BOT 未参加ギルドの検出ロジック
- 招待ボタン / リンクの UI
- 環境変数での招待 URL 管理

---

### 4. ギルド設定 (Server Settings)

**V2 の実装:**
- `ServerSetting.vue` で設定パネルを表示
- `restricted` フラグ: 管理者のみイベント編集を許可
- `getGuildConfig()` / `setGuildConfig()` で API 連携

**現行の状況:**
- 設定 UI なし
- 設定 API なし

**必要な作業:**
- ギルド設定 UI コンポーネント
- 設定 CRUD サービス
- DB スキーマ確認（既存の `bot_settings` テーブルを活用可能か）

---

### 5. ドキュメント / サポートページ

**V2 の実装:**
- `@nuxt/content` でマークダウンから動的ページ生成
- `/docs/:slug` - 使い方・FAQ 等
- `/support/:slug` - 利用規約・プライバシーポリシー

**現行の状況:**
- フッターにリンクはあるが、実際のページが存在しない

**必要な作業:**
- MDX または静的ページでのドキュメント実装
- 利用規約・プライバシーポリシーページ
- App Router のルーティング設定

---

### 6. 4 日表示ビュー

**V2 の実装:**
- Vuetify Calendar の `4day` ビュータイプ
- 週表示と日表示の中間的な表示

**現行の状況:**
- `react-big-calendar` では標準で 4 日ビューがない

**必要な作業:**
- `react-big-calendar` のカスタムビュー実装
- ツールバーへのビュー切り替え追加

---

### 7. カレンダー日付ピッカーナビゲーション

**V2 の実装:**
- ツールバーに日付ピッカーを配置
- カレンダーで特定の日付にジャンプ可能

**現行の状況:**
- 前/次/今日 ボタンのみ

**必要な作業:**
- 日付ピッカーコンポーネントの追加
- ツールバーへの組み込み

---

## 優先度マトリクス

### 高優先度（公開前に必須）

| # | 機能 | 理由 |
|---|------|------|
| 1 | ギルド権限チェック | セキュリティ上の必須要件 |
| 2 | イベント通知設定 | V2 コア機能、DB 準備済み |
| 3 | BOT 招待フロー | 新規ギルド追加に不可欠 |
| 4 | 利用規約・プライバシーポリシー | 法的要件 |

### 中優先度（公開後早期に対応）

| # | 機能 | 理由 |
|---|------|------|
| 5 | ギルド設定 | 管理者向けアクセス制御 |
| 6 | ドキュメントページ | ユーザーサポート |
| 7 | ドラッグリサイズ確認・実装 | UX 改善 |
| 8 | カレンダー日付ピッカー | ナビゲーション改善 |

### 低優先度（余裕があれば対応）

| # | 機能 | 理由 |
|---|------|------|
| 9 | 4 日表示ビュー | ニッチな需要 |
| 10 | 汎用ナビゲーションドロワー | 現状 UI で代替可能 |
| 11 | ログアウト専用ページ | サーバーアクションで十分 |
| 12 | Discord API トークンリフレッシュ強化 | Supabase SSR がカバー |

---

## V2 で未使用 / 移植不要な機能

| 機能 | 理由 |
|------|------|
| `/authorized` テストページ | 開発用のみ |
| Google Analytics プラグイン | 別途導入判断 |
| PWA サポート | 別途導入判断 |
| json-bigint | Supabase が BigInt を適切に処理 |
| Vuex ストア | React hooks + Supabase で代替済み |

---

## データモデル比較

### イベント

| フィールド | V2 | 現行 | 差異 |
|-----------|-----|------|------|
| id | number | UUID | ✅ 改善（UUID 採用） |
| guild_id | string | VARCHAR(32) | ✅ 同等 |
| name | VARCHAR(32) | VARCHAR(255) | ✅ 改善（文字数増加） |
| description | VARCHAR(500) | TEXT | ✅ 改善（制限なし） |
| color | string | VARCHAR(7) | ✅ 同等 |
| is_all_day | boolean | boolean | ✅ 同等 |
| start_at | DateTime | TIMESTAMPTZ | ✅ 同等 |
| end_at | DateTime | TIMESTAMPTZ | ✅ 同等 |
| notifications | Notification[] | 別テーブル | ⚠️ UI 未実装 |
| location | - | VARCHAR(255) | ✅ 新規追加 |
| channel_id | - | VARCHAR(32) | ✅ 新規追加 |
| channel_name | - | VARCHAR(100) | ✅ 新規追加 |
| created_at | DateTime | TIMESTAMPTZ | ✅ 同等 |
| updated_at | - | TIMESTAMPTZ | ✅ 新規追加 |

---

*最終更新: 2026-02-14*
