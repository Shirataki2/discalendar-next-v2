# Discord OAuth認証フロー 手動検証チェックリスト

本ドキュメントはTask 10.2に基づく手動検証項目を定義します。

## 概要

Discord OAuth認証機能の全体フローを手動で検証し、要件を満たしていることを確認します。

---

## 1. Discord Developer Portal設定確認

### 1.1 アプリケーション基本設定

| 項目 | 確認内容 | 確認結果 |
|------|----------|----------|
| Application Name | Discalendarまたは適切な名前が設定されている | [ ] |
| Application ID | 存在し、Supabaseに登録されている | [ ] |
| Public Key | 存在する | [ ] |

### 1.2 OAuth2設定

| 項目 | 確認内容 | 確認結果 |
|------|----------|----------|
| Client ID | 存在し、Supabase Dashboardに登録されている | [ ] |
| Client Secret | 存在し、Supabase Dashboardに登録されている | [ ] |
| Redirects | `https://{supabase-ref}.supabase.co/auth/v1/callback` が登録されている | [ ] |
| Scopes | `identify`と`email`が利用可能 | [ ] |

**確認手順:**
1. https://discord.com/developers/applications にアクセス
2. 対象アプリケーションを選択
3. 「OAuth2」セクションを確認
4. 「General」でClient ID/Secretを確認
5. 「Redirects」セクションでコールバックURLを確認

---

## 2. Supabase Dashboard設定確認

### 2.1 Discord OAuth Provider設定

| 項目 | 確認内容 | 確認結果 |
|------|----------|----------|
| Provider有効化 | Authentication > Providers > Discordが有効になっている | [ ] |
| Client ID | Discord Developer PortalのClient IDと一致している | [ ] |
| Client Secret | Discord Developer PortalのClient Secretと一致している | [ ] |

### 2.2 URL Configuration設定

| 項目 | 確認内容 | 確認結果 |
|------|----------|----------|
| Site URL | 本番環境のURLが設定されている | [ ] |
| Redirect URLs | 開発: `http://localhost:3000/auth/callback` が追加されている | [ ] |
| Redirect URLs | 本番: `https://{domain}/auth/callback` が追加されている | [ ] |

**確認手順:**
1. Supabase Dashboardにログイン
2. 対象プロジェクトを選択
3. Authentication > Providers > Discordを確認
4. Authentication > URL Configurationを確認

---

## 3. 開発環境でのOAuth認証フロー検証

### 3.1 正常系フロー（Requirement 2.1, 2.2, 2.3, 3.1, 3.2）

| Step | 操作 | 期待結果 | 確認結果 |
|------|------|----------|----------|
| 1 | `http://localhost:3000/auth/login` にアクセス | ログインページが表示される | [ ] |
| 2 | 「Discordでログイン」ボタンをクリック | ボタンがローディング状態になる | [ ] |
| 3 | (自動リダイレクト) | Discord認可画面が表示される | [ ] |
| 4 | Discord認可画面で「認証する」をクリック | アプリにリダイレクトされる | [ ] |
| 5 | (自動リダイレクト) | `/dashboard`に遷移する | [ ] |
| 6 | ダッシュボードページ | ユーザー名/アバターが表示される | [ ] |

### 3.2 認可スコープ確認（Requirement 2.2）

| 項目 | 確認内容 | 確認結果 |
|------|----------|----------|
| identify | Discord認可画面で「ユーザー名を読み取る」等の表示がある | [ ] |
| email | Discord認可画面で「メールアドレス」等の表示がある | [ ] |

### 3.3 セッション維持確認（Requirement 4.1, 4.2, 4.3）

| Step | 操作 | 期待結果 | 確認結果 |
|------|------|----------|----------|
| 1 | ログイン後、ページをリロード | ダッシュボードが表示される（再ログイン不要） | [ ] |
| 2 | ログイン後、新しいタブで`/dashboard`にアクセス | ダッシュボードが表示される | [ ] |
| 3 | ブラウザを閉じて再度開き、`/dashboard`にアクセス | セッションが維持されている | [ ] |

---

## 4. エラーハンドリング検証（Requirement 3.3, 3.4, 7.1, 7.2, 7.3, 7.4）

### 4.1 ユーザーによる認可拒否（Requirement 3.4）

| Step | 操作 | 期待結果 | 確認結果 |
|------|------|----------|----------|
| 1 | ログインページで「Discordでログイン」をクリック | Discord認可画面が表示される | [ ] |
| 2 | 「キャンセル」をクリック | `/auth/login?error=access_denied`にリダイレクト | [ ] |
| 3 | ログインページ | キャンセルメッセージが表示される | [ ] |

### 4.2 エラーパラメータ検証

| URL | 期待されるメッセージ | 確認結果 |
|-----|----------------------|----------|
| `/auth/login?error=network_error` | ネットワーク/サーバー接続エラーメッセージ | [ ] |
| `/auth/login?error=auth_failed` | 認証失敗メッセージ | [ ] |
| `/auth/login?error=access_denied` | キャンセルメッセージ | [ ] |
| `/auth/login?error=missing_code` | 認証コード不足メッセージ | [ ] |
| `/auth/login?error=session_expired` | セッション期限切れメッセージ | [ ] |

### 4.3 エラーログ確認（Requirement 7.4）

| 操作 | 確認内容 | 確認結果 |
|------|----------|----------|
| 認証エラー発生 | ブラウザコンソールに`[Auth Error]`ログが出力される | [ ] |
| コールバックエラー発生 | サーバーログに認証エラーが記録される | [ ] |

**確認手順:**
1. ブラウザの開発者ツールを開く（F12）
2. Consoleタブを選択
3. エラーを発生させて、ログを確認

---

## 5. ルーティング保護検証（Requirement 5.1, 5.2, 5.3）

### 5.1 未認証状態でのアクセス制御

| URL | 期待結果 | 確認結果 |
|-----|----------|----------|
| `/` | トップページが表示される | [ ] |
| `/auth/login` | ログインページが表示される | [ ] |
| `/auth/callback` | 正常に処理される（エラーページではない） | [ ] |
| `/dashboard` | `/auth/login`にリダイレクトされる | [ ] |

### 5.2 認証済み状態でのアクセス制御

| URL | 期待結果 | 確認結果 |
|-----|----------|----------|
| `/` | トップページが表示される | [ ] |
| `/auth/login` | `/dashboard`にリダイレクトされる | [ ] |
| `/dashboard` | ダッシュボードが表示される | [ ] |

---

## 6. ログアウト機能検証（Requirement 6.1, 6.2, 6.3）

### 6.1 正常系ログアウト

| Step | 操作 | 期待結果 | 確認結果 |
|------|------|----------|----------|
| 1 | ダッシュボードで「ログアウト」ボタンをクリック | ボタンがローディング状態になる | [ ] |
| 2 | (自動リダイレクト) | `/auth/login`に遷移する | [ ] |
| 3 | ログアウト後、`/dashboard`に直接アクセス | `/auth/login`にリダイレクトされる | [ ] |

### 6.2 セッションクリア確認

| 確認項目 | 確認方法 | 確認結果 |
|----------|----------|----------|
| Cookieクリア | 開発者ツール > Application > Cookiesでセッションが削除されている | [ ] |
| ページリロード | ログアウト後にリロードしてもログイン画面のまま | [ ] |

---

## 7. セキュリティ検証（Requirement 8.1, 8.2, 8.3, 8.4）

### 7.1 HTTPS通信（本番環境）

| 確認項目 | 確認内容 | 確認結果 |
|----------|----------|----------|
| 全通信がHTTPS | ブラウザのURL欄が「https://」で始まる | [ ] |
| 混合コンテンツなし | コンソールに混合コンテンツ警告がない | [ ] |

### 7.2 Cookie属性確認

| 属性 | 確認方法 | 確認結果 |
|------|----------|----------|
| HttpOnly | 開発者ツール > Application > Cookiesで確認 | [ ] |
| Secure | 本番環境でSecure属性が付与されている | [ ] |
| SameSite | SameSite=Laxが設定されている | [ ] |

**確認手順:**
1. 開発者ツールを開く（F12）
2. Application > Storage > Cookiesを選択
3. SupabaseのセッションCookieを確認

### 7.3 PKCEフロー確認

| 確認項目 | 確認方法 | 確認結果 |
|----------|----------|----------|
| code_verifier | OAuth開始時にlocalStorageに一時保存される | [ ] |
| code_challenge | 認可リクエストURLにcode_challengeパラメータが含まれる | [ ] |

**確認手順:**
1. 開発者ツール > Network タブを開く
2. ログインボタンをクリック
3. 認可リクエストのURLパラメータを確認

### 7.4 オープンリダイレクト防止

| テストURL | 期待結果 | 確認結果 |
|-----------|----------|----------|
| `/auth/callback?code=xxx&next=https://evil.com` | 外部サイトにリダイレクトされない | [ ] |
| `/auth/callback?code=xxx&next=//evil.com` | 外部サイトにリダイレクトされない | [ ] |

---

## 8. UI/UXアクセシビリティ検証

### 8.1 ログインページ

| 確認項目 | 確認内容 | 確認結果 |
|----------|----------|----------|
| キーボードナビゲーション | Tabキーでボタンにフォーカスできる | [ ] |
| フォーカス表示 | ボタンにフォーカス時、視覚的フィードバックがある | [ ] |
| スクリーンリーダー | ボタンの目的が読み上げられる | [ ] |
| エラーメッセージ | role="alert"でアナウンスされる | [ ] |

### 8.2 ダッシュボード

| 確認項目 | 確認内容 | 確認結果 |
|----------|----------|----------|
| アバター画像 | alt属性が適切に設定されている | [ ] |
| 見出し階層 | h1, h2が論理的に配置されている | [ ] |

---

## 検証結果サマリー

| カテゴリ | 合格項目数 | 総項目数 | 結果 |
|----------|------------|----------|------|
| Discord Developer Portal設定 | / | / | |
| Supabase Dashboard設定 | / | / | |
| 正常系フロー | / | / | |
| エラーハンドリング | / | / | |
| ルーティング保護 | / | / | |
| ログアウト機能 | / | / | |
| セキュリティ | / | / | |
| アクセシビリティ | / | / | |

**総合判定:** [ ] 合格 / [ ] 要修正

**検証実施日:** ____年__月__日

**検証者:** ________________

---

## 備考・発見した問題

```
（検証中に発見した問題や改善点を記載）



```
