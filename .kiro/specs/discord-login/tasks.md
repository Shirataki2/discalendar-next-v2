# Implementation Plan

## Task Overview

Discord OAuth認証機能の実装タスク。Supabase AuthとNext.js App Routerを統合し、DiscordアカウントでのログインからセッションManagement、ルーティング保護までを実装する。

---

## Tasks

- [x] 1. 認証基盤の型定義とユーティリティを整備する
  - 認証エラーコードとメッセージの型を定義する
  - エラーコードからユーザーフレンドリーなメッセージへの変換ロジックを実装する
  - 認証関連の定数（エラーコード、メッセージ）を集約する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 2. Middlewareによるセッション管理とルート保護を実装する
- [x] 2.1 (P) セッション更新処理をMiddlewareに統合する
  - 全リクエストでセッショントークンの更新処理を実行する
  - 既存のproxy.tsのupdateSession関数を呼び出す構造にする
  - 静的アセット（画像、CSS、JS）をMiddleware処理から除外する
  - _Requirements: 4.3, 4.4_

- [x] 2.2 認証状態に基づくルートリダイレクトを実装する
  - 未認証ユーザーが保護ルートにアクセス時、ログインページへリダイレクトする
  - 認証済みユーザーがログインページにアクセス時、ダッシュボードへリダイレクトする
  - 公開ルート（トップページ、認証関連ページ）は認証チェックをスキップする
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 3. Discordログインボタンを実装する
  - Discordブランドカラー（#5865F2）とロゴを使用したボタンを作成する
  - ボタンクリックでSupabase AuthのOAuth認証フローを開始する
  - 認証開始時にidentifyとemailスコープをリクエストする
  - ローディング状態を表示しボタン連打を防止する
  - キーボード操作（Enter/Space）でアクティベート可能にする
  - フォーカス時に視覚的なフィードバックを表示する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2_

- [x] 4. ログインページを実装する
  - DiscordログインボタンをClient Componentとして配置する
  - URLパラメータからエラーメッセージを取得して表示する
  - ネットワークエラー、認証失敗、認可キャンセルのメッセージを区別して表示する
  - アクセシビリティを考慮したレイアウトを構成する
  - _Requirements: 1.1, 7.1, 7.2, 7.3_

- [x] 5. OAuthコールバック処理を実装する
  - Discordから返却される認可コードを受け取る
  - 認可コードをセッショントークンに交換する
  - セッション確立成功時、ダッシュボードまたは指定されたリダイレクト先に遷移する
  - 認可コード欠落、トークン交換失敗、ユーザーによる認可拒否を検出する
  - エラー発生時、適切なエラーコードをログインページに渡してリダイレクトする
  - CookieベースでSupabaseセッションを保存する
  - コールバックURLがSupabase設定と一致することを確認する
  - _Requirements: 2.3, 3.1, 3.2, 3.3, 3.4, 4.1_

- [x] 6. ログアウト機能を実装する
- [x] 6.1 (P) ログアウトのServer Actionを作成する
  - サーバー側でSupabaseセッションを破棄する
  - セッション破棄後、ログインページへリダイレクトする
  - _Requirements: 6.1, 6.2_

- [x] 6.2 ログアウトボタンコンポーネントを作成する
  - ログアウトServer Actionを呼び出すボタンを実装する
  - クライアント側のセッション情報をクリアする
  - ボタンのバリエーション（default, ghost, outline）に対応する
  - _Requirements: 6.1, 6.3_

- [x] 7. ダッシュボードページを作成する
  - 認証後のランディングページとして基本構造を実装する
  - ログアウトボタンを配置する
  - 認証済みユーザー情報（ユーザー名、アバター）を表示する
  - Server ComponentsとClient Componentsでユーザー情報を参照できることを確認する
  - _Requirements: 4.2_

- [x] 8. 既存ヘッダーのログインリンクを更新する
  - ヘッダーのログインリンク先を新しいログインページに変更する
  - 認証状態に応じてログイン/ログアウトの表示を切り替える
  - _Requirements: 1.1_

- [x] 9. セキュリティ要件の検証とエラーログの実装
  - PKCEフローが正しく動作することを確認する
  - セッションCookieにHttpOnly、Secure、SameSite属性が設定されていることを確認する
  - CSRFトークン検証がSupabase組み込み機能で動作していることを確認する
  - 全ての認証エラーをコンソールに記録する処理を実装する
  - HTTPS通信が本番環境で強制されることを確認する
  - _Requirements: 7.4, 8.1, 8.2, 8.3, 8.4_

- [x] 10. 統合テストと動作検証
- [x] 10.1 E2Eテストシナリオを作成する
  - ログインページでDiscordボタンが表示されることを検証する
  - 未認証での保護ルートアクセスがリダイレクトされることを検証する
  - 認証済みでのログインページアクセスがダッシュボードへリダイレクトされることを検証する
  - ログアウト後にログインページへ遷移することを検証する
  - _Requirements: 1.1, 5.1, 5.2, 6.2_

- [x] 10.2 認証フロー全体の手動検証を実施する
  - Discord Developer Portalでのアプリケーション設定を確認する
  - Supabase DashboardでのDiscord OAuth Provider設定を確認する
  - 開発環境でのOAuth認証フロー完了を確認する
  - エラーハンドリングの各パターンを確認する
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3, 1.4 | 3, 4, 8, 10.1 |
| 2.1, 2.2, 2.3 | 3, 5, 10.2 |
| 3.1, 3.2, 3.3, 3.4 | 5, 10.2 |
| 4.1, 4.2, 4.3, 4.4 | 2.1, 5, 7 |
| 5.1, 5.2, 5.3 | 2.2, 10.1 |
| 6.1, 6.2, 6.3 | 6.1, 6.2, 10.1 |
| 7.1, 7.2, 7.3, 7.4 | 1, 4, 9 |
| 8.1, 8.2, 8.3, 8.4 | 9 |
