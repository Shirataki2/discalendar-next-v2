# Implementation Plan

## Task 1: UI基盤セットアップ

- [x] 1.1 shadcn/uiのDialogとAlertDialogコンポーネントを追加する
  - DialogコンポーネントをプロジェクトにインストールしてEventDialog用の基盤を整備する
  - AlertDialogコンポーネントをインストールしてConfirmDialog用の基盤を整備する
  - インストール後にコンポーネントが正しく動作することを確認する
  - _Requirements: 1.3, 1.7, 3.1, 3.6, 4.1, 4.4_

## Task 2: データ層の拡張

- [ ] 2.1 (P) EventServiceにイベント作成機能を追加する
  - 予定の新規作成ロジックをSupabaseへのINSERT操作として実装する
  - 必須フィールド（タイトル、開始日時、終了日時）とオプションフィールド（説明、終日フラグ、色、場所）を処理する
  - Result型パターンに従ったエラーハンドリングを実装する
  - _Requirements: 1.4_

- [ ] 2.2 (P) EventServiceにイベント更新機能を追加する
  - 既存予定の更新ロジックをSupabaseへのUPDATE操作として実装する
  - 部分更新に対応し、変更されたフィールドのみを更新する
  - Result型パターンでエラー（404、認証エラー等）を適切に返却する
  - _Requirements: 3.3_

- [ ] 2.3 (P) EventServiceにイベント削除機能を追加する
  - 予定の完全削除ロジックをSupabaseへのDELETE操作として実装する
  - 削除成功・失敗をResult型で返却する
  - 削除後は復元不可能であることを保証する
  - _Requirements: 4.2, 4.5_

- [ ] 2.4 (P) Supabase RLSポリシーを追加するマイグレーションを作成する
  - 認証済みユーザーによるイベント作成を許可するINSERTポリシーを追加する
  - 認証済みユーザーによるイベント更新を許可するUPDATEポリシーを追加する
  - 認証済みユーザーによるイベント削除を許可するDELETEポリシーを追加する
  - _Requirements: 1.4, 3.3, 4.2_

## Task 3: フォーム状態管理

- [ ] 3.1 (P) 予定入力フォームのバリデーションと状態管理を行うカスタムフックを作成する
  - フォームフィールド（タイトル、開始日時、終了日時、説明、終日フラグ）の状態管理を実装する
  - タイトル必須（1-255文字）、日時必須、終了日時が開始日時以降であることのバリデーションを実装する
  - フィールドごとのエラー状態とタッチ状態を管理する
  - 初期値の設定と状態のリセット機能を提供する
  - _Requirements: 1.6, 3.5_

## Task 4: イベントCRUD操作フック

- [ ] 4.1 EventServiceを使用したミューテーション操作を管理するカスタムフックを作成する
  - 作成・更新・削除の各操作のローディング状態を管理する
  - EventServiceの各メソッドを呼び出してCRUD操作を実行する
  - 操作成功時と失敗時のコールバックをサポートする
  - エラー状態の保持とクリア機能を提供する
  - Task 2のEventService拡張に依存
  - _Requirements: 1.4, 3.3, 4.2_

## Task 5: UIコンポーネント実装

- [ ] 5.1 予定入力フォームコンポーネントを作成する
  - タイトル、開始日時、終了日時、説明、終日フラグを入力できるフォームを実装する
  - HTML5のdatetime-local入力を使用して日時選択を提供する
  - バリデーションエラーをフィールドごとに表示する
  - 保存中のローディング状態とキャンセルボタンを提供する
  - Storybookストーリーを作成する（初期値あり/なし、バリデーションエラー状態）
  - Task 1.1（Dialog）とTask 3.1（useEventForm）に依存
  - _Requirements: 1.3, 1.6, 3.2, 3.5_

- [ ] 5.2 予定作成・編集ダイアログコンポーネントを作成する
  - 新規作成モードと編集モードを切り替えられるダイアログを実装する
  - 初期値（期間選択時の開始・終了日時、編集時の既存データ）を受け取る
  - 保存成功時にダイアログを閉じて親に通知する
  - キャンセル時やダイアログ外クリック時に入力内容を破棄して閉じる
  - Storybookストーリーを作成する（create/editモード、ローディング状態）
  - Task 5.1（EventForm）に依存
  - _Requirements: 1.3, 1.5, 1.7, 3.1, 3.2, 3.4, 3.6_

- [ ] 5.3 削除確認ダイアログコンポーネントを作成する
  - 削除操作の確認メッセージを表示するダイアログを実装する
  - 確認ボタンとキャンセルボタンを提供する
  - 確認時にコールバックを実行し、キャンセル時はダイアログを閉じる
  - 削除処理中のローディング状態を表示する
  - Storybookストーリーを作成する（デフォルト、ローディング状態）
  - Task 1.1（AlertDialog）に依存
  - _Requirements: 4.1, 4.4_

## Task 6: 既存コンポーネント拡張

- [ ] 6.1 (P) EventPopoverに編集・削除ボタンを追加する
  - プレビュー表示に編集ボタンと削除ボタンを追加する
  - 編集ボタンクリック時に親コンポーネントへ編集開始を通知する
  - 削除ボタンクリック時に親コンポーネントへ削除開始を通知する
  - 既存のプレビュー表示機能（タイトル、日時、説明の読み取り専用表示）を維持する
  - _Requirements: 2.3_

- [ ] 6.2 (P) CalendarToolbarに新規追加ボタンを追加する
  - ツールバーに予定新規追加ボタンを配置する
  - ボタンクリック時に親コンポーネントへ新規追加開始を通知する
  - 既存のナビゲーション・ビュー切替機能を維持する
  - _Requirements: 1.2_

- [ ] 6.3 CalendarGridにドラッグ選択時のハイライト表示を追加する
  - 期間選択中の視覚的フィードバックを強化する
  - 選択中のスロットをハイライト表示する
  - ドラッグ完了時に選択された期間情報を親に通知する
  - _Requirements: 1.1, 5.3_

## Task 7: カレンダーコンテナ統合

- [ ] 7.1 CalendarContainerに予定作成フローを統合する
  - 新規追加ボタンクリック時にEventDialogを表示する
  - ドラッグで期間選択時に選択期間を初期値としてEventDialogを表示する
  - 予定保存成功時にカレンダーのイベント一覧を再取得して表示を更新する
  - Task 4.1（useEventMutation）、Task 5.2（EventDialog）、Task 6.2（Toolbar）に依存
  - _Requirements: 1.1, 1.2, 1.4, 1.5_

- [ ] 7.2 CalendarContainerに予定編集・削除フローを統合する
  - EventPopoverの編集ボタンから既存データを設定してEventDialogを表示する
  - 予定更新成功時にダイアログを閉じてカレンダー表示を更新する
  - EventPopoverの削除ボタンからConfirmDialogを表示する
  - 削除確認後に予定を削除してカレンダー表示から除去する
  - Task 5.3（ConfirmDialog）、Task 6.1（EventPopover）に依存
  - _Requirements: 2.3, 3.1, 3.3, 3.4, 4.1, 4.2, 4.3_

## Task 8: UI操作性向上

- [ ] 8.1 (P) カレンダー上の予定にホバー時のツールチップを追加する
  - 予定にマウスホバーした際に基本情報（タイトル、時間）をツールチップで表示する
  - ツールチップはクリック操作の妨げにならないよう適切に配置する
  - _Requirements: 5.4_

## Task 9: テスト実装

- [ ] 9.1 useEventFormのユニットテストを作成する
  - バリデーションロジックの正常系・異常系をテストする
  - 状態遷移（入力、エラー、リセット）をテストする
  - 初期値設定とフィールド変更をテストする
  - _Requirements: 1.6, 3.5_

- [ ] 9.2 useEventMutationのユニットテストを作成する
  - 作成・更新・削除の各操作のResult処理をテストする
  - ローディング状態の遷移をテストする
  - エラー状態の保持とクリアをテストする
  - _Requirements: 1.4, 3.3, 4.2_

- [ ] 9.3 EventServiceのCRUDメソッドのユニットテストを作成する
  - Supabaseクライアントをモックして各操作をテストする
  - 正常系と各種エラーパターン（認証エラー、ネットワークエラー等）をテストする
  - _Requirements: 1.4, 3.3, 4.2, 4.5_

- [ ] 9.4 E2Eテストを作成する
  - 新規予定作成フロー（ドラッグ選択、フォーム入力、保存、カレンダー表示確認）をテストする
  - 予定編集フロー（クリック、プレビュー、編集、保存、表示確認）をテストする
  - 予定削除フロー（クリック、プレビュー、削除、確認、表示確認）をテストする
  - バリデーションエラー表示（必須項目未入力で保存試行）をテストする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4_
