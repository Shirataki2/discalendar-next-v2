# Implementation Plan

## Task Overview

本実装計画は、DiscalendarダッシュボードにGoogleカレンダー風のカレンダーUIを追加する。react-big-calendarとdate-fnsを使用し、日/週/月ビューの切り替え、イベント表示、レスポンシブ対応、アクセシビリティ対応を実現する。

---

## Tasks

- [x] 1. カレンダーライブラリのセットアップ
  - react-big-calendarとdate-fnsをプロジェクトに導入する
  - date-fns日本語ロケールを設定したdateFnsLocalizerを作成する
  - react-big-calendarのCSSをグローバルスタイルまたはコンポーネント単位でインポートする
  - Tailwind CSSとの競合を確認し、必要なオーバーライドスタイルを準備する
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2. イベントデータ取得サービスの実装
- [x] 2.1 イベント型定義とデータ変換ロジックの作成
  - Supabaseから取得するEventRecordの型定義を作成する
  - カレンダー表示用のCalendarEvent型を定義する
  - EventRecordからCalendarEventへの変換関数を実装する
  - 終日イベントフラグ、場所情報、チャンネル情報のマッピングを含める
  - _Requirements: 3.1, 9.1_

- [x] 2.2 EventServiceの実装
  - ギルドIDと日付範囲に基づくイベント取得クエリを実装する
  - 成功時はイベント配列、失敗時はエラー情報を返すResult型を使用する
  - エラーコード（FETCH_FAILED, NETWORK_ERROR, UNAUTHORIZED）を適切に分類する
  - 重複リクエスト防止のためAbortController対応を含める
  - _Requirements: 5.1, 5.3, 5.4_

- [x] 3. カレンダーコンテナの状態管理実装
- [x] 3.1 カレンダー状態管理フックの作成
  - ビューモード（day/week/month）の状態管理を実装する
  - 選択日付の状態管理を実装する
  - ローディング状態とエラー状態の管理を実装する
  - デフォルトで月ビューを表示する初期状態を設定する
  - _Requirements: 1.4, 5.3_

- [x] 3.2 URLパラメータとの状態同期
  - useSearchParamsを使用してビューモードと日付をURL同期する
  - 不正なURLパラメータは今日の日付にフォールバックする
  - ビューモード変更時にURLを更新する
  - ブラウザの戻る/進む操作に対応する
  - _Requirements: 1.5, 2.4_

- [x] 3.3 CalendarContainerコンポーネントの実装
  - ギルドIDを受け取りEventServiceでイベントを取得する
  - ギルド選択変更時にイベントデータを再取得する
  - ギルド未選択時は空のカレンダーグリッドを表示する
  - 子コンポーネント（Toolbar, Grid）にデータとハンドラーを配布する
  - _Requirements: 5.1, 5.2_

- [ ] 4. ツールバーUIの実装
- [ ] 4.1 (P) ビューモード切り替えUIの作成
  - 日/週/月の3つのビュー切り替えボタンを配置する
  - 現在選択中のビューモードを視覚的に強調する
  - shadcn/ui Buttonコンポーネントをベースに実装する
  - ボタングループとしてアクセシブルなマークアップを適用する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 (P) 日付ナビゲーションコントロールの作成
  - 前へ/次へボタンで期間を移動する機能を実装する
  - 今日ボタンで本日を含む期間にジャンプする機能を実装する
  - 現在表示中の期間ラベル（例: 「2025年12月」）を表示する
  - ビューモードに応じて移動単位（日/週/月）を切り替える
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 4.3 CalendarToolbarコンポーネントの統合
  - ビュー切り替えとナビゲーションを1つのツールバーに統合する
  - CalendarContainerからpropsを受け取り状態変更を通知する
  - モバイル向けのコンパクトレイアウトを準備する
  - _Requirements: 1.5, 2.4_

- [ ] 5. カレンダーグリッドの基本実装
- [ ] 5.1 react-big-calendarのラッパーコンポーネント作成
  - dateFnsLocalizerを使用してreact-big-calendarを初期化する
  - ビューモードと選択日付をpropsから受け取り反映する
  - イベントクリック時のハンドラーを設定する
  - 日付セル選択時のハンドラーを設定する
  - _Requirements: 1.1, 1.2, 1.3, 3.1_

- [ ] 5.2 イベント配置と表示の設定
  - イベントを開始日時に基づいてグリッド上に配置する
  - 日/週ビューでイベントの継続時間に応じた高さを設定する
  - 月ビューでイベントをコンパクトなバー形式で表示する
  - 同一時間帯の複数イベントを横並びで表示する
  - _Requirements: 3.2, 3.3, 3.4, 3.5_

- [ ] 5.3 月ビューの表示制限と追加イベント表示
  - 月ビューの日付セルあたりの表示イベント数を制限する
  - 表示しきれないイベントは「+N件」形式で残数を表示する
  - 表示月外の日付セルを視覚的に区別する
  - _Requirements: 2.5, 3.6_

- [ ] 5.4 今日の日付ハイライト機能の実装
  - dayPropGetterを使用して今日の日付セルをハイライトする
  - 月ビューで今日の日付番号を強調表示する
  - 週ビューで今日の列ヘッダーを強調表示する
  - 日ビューで今日表示時にヘッダーを強調する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 6. イベントブロックのカスタマイズ
- [ ] 6.1 (P) EventBlockカスタムレンダラーの作成
  - react-big-calendarのcomponents.eventでカスタムレンダラーを設定する
  - イベント名を表示し、長いテキストは省略する
  - イベントカラーを背景色として適用する
  - クリックとキーボード操作でのイベント選択に対応する
  - _Requirements: 3.7, 8.4_

- [ ] 6.2 (P) 終日イベントの視覚的区別
  - 終日イベントと時間指定イベントを異なるスタイルで表示する
  - 月ビューで終日イベントを日付セル上部にバー形式で配置する
  - 週/日ビューで終日イベントを時間軸上部の専用エリアに表示する
  - 同一日の複数終日イベントを縦に積み重ねて表示する
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.6_

- [ ] 7. イベント詳細ポップオーバーの実装
- [ ] 7.1 (P) EventPopoverコンポーネントの作成
  - shadcn/ui Popoverをベースにイベント詳細表示を実装する
  - イベント名、開始/終了日時、説明文を表示する
  - 終日イベントの場合は時刻ではなく「終日」と表示する
  - 場所情報とDiscordチャンネル情報を条件付きで表示する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 9.5_

- [ ] 7.2 (P) ポップオーバーの表示位置と閉じ動作
  - クリックしたイベント要素の近くにポップオーバーを表示する
  - 画面端での表示位置を自動調整し、はみ出しを防止する
  - ポップオーバー外クリックで閉じる動作を実装する
  - Escキー押下で閉じる動作を実装する
  - _Requirements: 4.5, 4.6, 4.7_

- [ ] 8. レスポンシブデザインの実装
- [ ] 8.1 デスクトップとタブレット向けレイアウト
  - デスクトップ（1024px以上）で全ビューモードを完全表示する
  - タブレット（768px-1024px）で週ビューのカラム幅を調整する
  - 横スクロールなしで全コンテンツを閲覧可能にする
  - _Requirements: 6.1, 6.2, 6.5_

- [ ] 8.2 モバイル向けレイアウトとデフォルトビュー
  - モバイル（768px未満）でデフォルトビューを日ビューに変更する
  - モバイルでは週ビューを簡略化または非表示にする
  - ツールバーをモバイル向けにコンパクト化する
  - タッチデバイスでのタップ操作に対応する
  - _Requirements: 6.3, 6.4_

- [ ] 9. アクセシビリティ対応の実装
- [ ] 9.1 キーボードナビゲーションの実装
  - 矢印キーでの日付間移動に対応する
  - Tabキーでのフォーカス移動に対応する
  - イベントにフォーカスがある状態でEnterキーでポップオーバーを開く
  - フォーカス状態の視覚的インジケーターを表示する
  - _Requirements: 8.1, 8.4_

- [ ] 9.2 ARIAラベルとセマンティクスの適用
  - 日付セルにARIAグリッドロールを適用する
  - 各UI要素に適切なARIAラベルを設定する
  - ナビゲーションボタンにアクセシブルな名前を設定する
  - イベントブロックにイベント情報を読み上げ可能にする
  - _Requirements: 8.2, 8.3_

- [ ] 9.3 カラーコントラストの検証と調整
  - イベントカラーと背景のコントラスト比を検証する
  - WCAG AA基準を満たすカラーパレットを適用する
  - ハイライト表示のコントラストを確保する
  - _Requirements: 8.5_

- [ ] 10. ダッシュボードへの統合とエラーハンドリング
- [ ] 10.1 ダッシュボードページへのカレンダー統合
  - ダッシュボードページにCalendarContainerを配置する
  - ギルドセレクターとカレンダーを連携させる
  - ギルド選択変更時にカレンダーを更新する
  - 初期ロード時のデータ取得フローを確立する
  - _Requirements: 5.1, 5.2_

- [ ] 10.2 ローディングとエラー状態のUI実装
  - イベントデータ読み込み中のローディングインジケーターを表示する
  - データ取得失敗時のエラーメッセージを表示する
  - 再試行ボタンを提供し、エラーからの回復を可能にする
  - ネットワークエラーとサーバーエラーを区別して表示する
  - _Requirements: 5.3, 5.4_

- [ ] 10.3 統合テストとエンドツーエンド検証
  - ビューモード切り替えの動作を検証する
  - 日付ナビゲーションの動作を検証する
  - イベントクリックからポップオーバー表示・閉じるまでのフローを検証する
  - レスポンシブ表示の各ブレークポイントを検証する
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 4.1, 4.5, 4.6_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1 (ビューモード切り替え) | 1, 4.1, 4.3, 5.1, 10.3 |
| 2 (日付ナビゲーション) | 3.2, 4.2, 4.3, 5.3, 10.3 |
| 3 (イベントグリッド表示) | 2.1, 5.1, 5.2, 5.3, 6.1 |
| 4 (イベント詳細ポップオーバー) | 7.1, 7.2, 10.3 |
| 5 (ギルド選択連携) | 2.2, 3.1, 3.3, 10.1, 10.2 |
| 6 (レスポンシブデザイン) | 8.1, 8.2 |
| 7 (今日の日付ハイライト) | 5.4 |
| 8 (アクセシビリティ) | 6.1, 9.1, 9.2, 9.3 |
| 9 (終日イベント表示) | 2.1, 6.2, 7.1 |
