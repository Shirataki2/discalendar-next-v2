# Implementation Plan

## Task Overview

ダッシュボードにおけるDiscord所属ギルド一覧表示機能の実装タスク。

**総タスク数**: 7 major tasks, 17 sub-tasks
**推定作業時間**: 各サブタスク 1-3時間

---

## Tasks

- [x] 1. データベーススキーマの構築
- [x] 1.1 (P) guildsテーブルを作成するSupabaseマイグレーションを実装
  - ギルドID、名前、アバターURL、ロケールを格納するテーブル定義
  - guild_idカラムに一意制約とインデックスを設定
  - ロケールのデフォルト値を日本語に設定
  - _Requirements: 1.1, 1.2_

- [x] 1.2 (P) Row Level Securityポリシーを設定
  - guildsテーブルでRLSを有効化
  - 認証済みユーザーに対してSELECT権限のみを許可するポリシーを作成
  - _Requirements: 1.3_

- [x] 2. 型定義の整備
- [x] 2.1 (P) ギルド関連の内部型を定義
  - アプリケーション内部で使用するギルド型を作成（ID、ギルドID、名前、アバターURL、ロケール）
  - Supabase自動生成型との互換性を確保
  - _Requirements: 6.1, 6.2_

- [x] 2.2 (P) Discord APIレスポンス用の型を定義
  - Discord APIから返却されるPartial Guild Object型を作成
  - ギルドID、名前、アイコンハッシュ、所有者フラグ、権限を含める
  - _Requirements: 6.3_

- [x] 2.3 (P) エラー型とAPI結果型を定義
  - Discord API呼び出しの成功・失敗を表現するResult型を作成
  - トークン期限切れ、レート制限、ネットワークエラーなどのエラー種別を定義
  - ギルド一覧UIで使用するエラー型を作成
  - _Requirements: 2.3, 2.4_

- [x] 3. Discord API連携クライアントの実装
- [x] 3.1 Discord APIクライアントを実装
  - Discordアクセストークンを使用してユーザー所属ギルド一覧を取得する機能を実装
  - 各ギルドのID、名前、アイコン情報を取得
  - HTTPステータスコードに応じたエラーハンドリング（認証エラー、レート制限など）
  - 401エラー時は認証エラーとして返却
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - _Contracts: DiscordApiClient Service Interface_

- [x] 4. ギルドサービスの実装
- [x] 4.1 ギルド照合サービスを実装
  - Discord APIから取得したギルドIDリストでSupabaseのguildsテーブルを検索
  - ANY演算子を使用した一括クエリでN+1問題を回避
  - DBに登録済みかつユーザーが所属しているギルドのみを返却
  - 空のギルドIDリストの場合は即座に空配列を返却
  - _Requirements: 3.1, 3.2, 3.3_
  - _Contracts: GuildService Service Interface_

- [x] 5. UIコンポーネントの実装
- [x] 5.1 (P) ギルドカードコンポーネントを実装
  - ギルド名とアイコン画像を表示するカードUIを作成
  - Discord CDNからギルドアイコン画像を取得して表示
  - アイコン未設定時はギルド名のイニシャルをフォールバック表示
  - shadcn/ui Cardとnext/imageを使用
  - _Requirements: 4.2, 4.3_

- [x] 5.2 (P) ギルド一覧クライアントコンポーネントを実装
  - ギルド配列をグリッドレイアウトでカード形式表示
  - 利用可能なギルドがない場合の空状態メッセージを表示
  - ローディング中のインジケーター表示
  - エラー発生時のメッセージ表示（API失敗、トークン期限切れなど）
  - _Requirements: 4.1, 4.4, 4.5_

- [ ] 6. ダッシュボードページの統合
- [ ] 6.1 OAuth scopeにguildsを追加
  - Discord OAuth認証でguildsスコープを要求するよう設定を更新
  - _Requirements: 2.1_

- [ ] 6.2 Next.js画像設定にDiscord CDNギルドアイコン用パターンを追加
  - remotePatternにDiscord CDNのiconsパスを追加
  - _Requirements: 4.2_

- [ ] 6.3 ダッシュボードServer Componentにギルド取得ロジックを統合
  - Supabase Authからprovider_tokenを取得
  - Discord APIクライアントを使用してユーザー所属ギルドを取得
  - ギルドサービスでDB照合を実行
  - 取得したギルド情報をクライアントコンポーネントに渡す
  - 未認証ユーザーをログインページへリダイレクト
  - provider_token未取得時は再認証を促すメッセージを表示
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 2.1, 2.4_

- [ ] 7. テストの実装
- [ ] 7.1 (P) Discord APIクライアントの単体テストを実装
  - 正常レスポンス時のギルド一覧取得テスト
  - 認証エラー（401）時のエラーハンドリングテスト
  - レート制限（429）時のエラーハンドリングテスト
  - ネットワークエラー時のエラーハンドリングテスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 7.2 (P) ギルドサービスの単体テストを実装
  - 空のギルドIDリストでの動作テスト
  - 単一ギルドID照合テスト
  - 複数ギルドID一括照合テスト
  - DBに存在しないギルドIDのフィルタリングテスト
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 7.3 (P) ギルドカードコンポーネントのテストを実装
  - アイコンありギルドの表示テスト
  - アイコンなしギルドのイニシャルフォールバックテスト
  - _Requirements: 4.2, 4.3_

- [x] 7.4* (P) ギルド一覧クライアントコンポーネントのテストを実装
  - ギルド一覧のグリッド表示テスト
  - 空状態メッセージの表示テスト
  - エラー状態メッセージの表示テスト
  - _Requirements: 4.1, 4.4, 4.5_

---

## Requirements Coverage Matrix

| Requirement | Task(s) |
|-------------|---------|
| 1.1 | 1.1 |
| 1.2 | 1.1 |
| 1.3 | 1.2 |
| 2.1 | 3.1, 6.1, 6.3, 7.1 |
| 2.2 | 3.1, 7.1 |
| 2.3 | 2.3, 3.1, 7.1 |
| 2.4 | 2.3, 3.1, 6.3, 7.1 |
| 3.1 | 4.1, 7.2 |
| 3.2 | 4.1, 7.2 |
| 3.3 | 4.1, 7.2 |
| 4.1 | 5.2, 7.4 |
| 4.2 | 5.1, 6.2, 7.3 |
| 4.3 | 5.1, 7.3 |
| 4.4 | 5.2, 7.4 |
| 4.5 | 5.2, 7.4 |
| 5.1 | 6.3 |
| 5.2 | 6.3 |
| 5.3 | 6.3 |
| 5.4 | 6.3 |
| 6.1 | 2.1 |
| 6.2 | 2.1 |
| 6.3 | 2.2 |

**Coverage**: 22/22 acceptance criteria mapped (100%)
